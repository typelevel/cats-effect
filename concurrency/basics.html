<!DOCTYPE html><html><head><title>Cats Effect: Concurrency Basics</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Cats Effect contributors" /><meta name="description" content="The IO Monad for Scala" /><meta name="og:image" content="/cats-effect/img/poster.png" /><meta name="image" property="og:image" content="/cats-effect/img/poster.png" /><meta name="og:title" content="Cats Effect: Concurrency Basics" /><meta name="title" property="og:title" content="Cats Effect: Concurrency Basics" /><meta name="og:site_name" content="Cats Effect" /><meta name="og:url" content="https://typelevel.org/cats-effect/" /><meta name="og:type" content="website" /><meta name="og:description" content="The IO Monad for Scala" /><link rel="icon" type="image/png" href="/cats-effect/img/favicon.png" /><meta name="twitter:title" content="Cats Effect: Concurrency Basics" /><meta name="twitter:image" content="/cats-effect/img/poster.png" /><meta name="twitter:description" content="The IO Monad for Scala" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:creator" content="@typelevel" /><link rel="icon" type="image/png" sizes="16x16" href="/cats-effect/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/cats-effect/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/cats-effect/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/cats-effect/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/cats-effect/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/cats-effect/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/cats-effect/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/cats-effect/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/cats-effect/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/cats-effect/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/cats-effect/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/cats-effect/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/cats-effect/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/cats-effect/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/cats-effect/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/cats-effect/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/cats-effect/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/cats-effect/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/cats-effect/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/cats-effect/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/cats-effect/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/cats-effect/css/light-style.css" /><link rel="stylesheet" href="/cats-effect/css/toc.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/cats-effect/" class="brand"><div class="brand-wrapper"></div><span>Cats Effect</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/cats-effect/datatypes/" title="Data Types" class="drop-nested">Data Types</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/cats-effect/datatypes/io.html" title="IO" class="">IO</a> <a href="/cats-effect/datatypes/syncio.html" title="SyncIO" class="">SyncIO</a> <a href="/cats-effect/datatypes/fiber.html" title="Fiber" class="">Fiber</a> <a href="/cats-effect/datatypes/resource.html" title="Resource" class="">Resource</a> <a href="/cats-effect/datatypes/clock.html" title="Clock" class="">Clock</a> <a href="/cats-effect/datatypes/contextshift.html" title="ContextShift" class="">ContextShift</a> <a href="/cats-effect/datatypes/timer.html" title="Timer" class="">Timer</a> <a href="/cats-effect/datatypes/ioapp.html" title="IOApp" class="">IOApp</a></div></div> <div class="sidebar-nav-item  open"><a href="/cats-effect/concurrency/" title="Concurrency" class="drop-nested">Concurrency</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/cats-effect/concurrency/basics.html" title="Concurrency Basics" class="active">Concurrency Basics</a> <a href="/cats-effect/concurrency/deferred.html" title="Deferred" class="">Deferred</a> <a href="/cats-effect/concurrency/mvar.html" title="MVar" class="">MVar</a> <a href="/cats-effect/concurrency/ref.html" title="Ref" class="">Ref</a> <a href="/cats-effect/concurrency/semaphore.html" title="Semaphore" class="">Semaphore</a></div></div> <div class="sidebar-nav-item  "><a href="/cats-effect/typeclasses/" title="Type Classes" class="drop-nested">Type Classes</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/cats-effect/typeclasses/bracket.html" title="Bracket" class="">Bracket</a> <a href="/cats-effect/typeclasses/sync.html" title="Sync" class="">Sync</a> <a href="/cats-effect/typeclasses/liftio.html" title="LiftIO" class="">LiftIO</a> <a href="/cats-effect/typeclasses/async.html" title="Async" class="">Async</a> <a href="/cats-effect/typeclasses/concurrent.html" title="Concurrent" class="">Concurrent</a> <a href="/cats-effect/typeclasses/effect.html" title="Effect" class="">Effect</a> <a href="/cats-effect/typeclasses/concurrent-effect.html" title="ConcurrentEffect" class="">ConcurrentEffect</a></div></div> <div class="sidebar-nav-item  "><a href="/cats-effect/tutorial/tutorial.html" title="Tutorial" class="">Tutorial</a></div> <div class="sidebar-nav-item  "><a href="/cats-effect/tracing/" title="Tracing" class="">Tracing</a></div> <div class="sidebar-nav-item  "><a href="/cats-effect/testing/" title="Testing" class="">Testing</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/typelevel/cats-effect" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/typelevel/cats-effect" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="typelevel" data-github-repo="cats-effect"><div class="content-wrapper"><section><h1>Concurrency Basics</h1>

<h2 id="introduction">Introduction</h2>

<p>Concurrency is not an easy topic. There are a lot of concepts involved and the vocabulary might be hard to search.
This post intends to gather and explain some of the most important ideas and serve as a reference point for
understanding the basics of concurrency.
It is focused on using Scala with libraries in Cats-Effect ecosystem.</p>

<h2 id="dictionary">Dictionary</h2>

<p class="responsive-pic"><img src="/cats-effect/img/concurrency-vs-parallelism.png" alt="concurrency vs parallelism" /></p>

<h3 id="parallelism">Parallelism</h3>
<p>Using multiple computational resources (like more processor cores) to perform a computation faster,
usually executing at the same time.</p>

<p>Example: summing a list of Integers by dividing it in half and calculating both halves in parallel.</p>

<p>Main concern: efficiency.</p>

<h3 id="concurrency">Concurrency</h3>
<p>Multiple tasks interleaved. Concurrency doesn’t have to be multithreaded. We can
write concurrent applications on single processor using methods such as event loops.</p>

<p>Example: Communicating with external services through HTTP.</p>

<p>Main concern: interaction with multiple, independent and external agents.</p>

<h3 id="cpu-bound-task">CPU-bound task</h3>
<p>Operation that mostly requires processor resources to finish its computation.</p>

<h3 id="io-bound-task">IO-bound task</h3>
<p>Operation that mostly does I/O and it doesn’t depend on your computation resources,
e.g. waiting for disk operation to finish or external service to answer your request.</p>

<h3 id="non-terminating-task">Non-terminating task</h3>
<p>Task that will never signal its result. A task can be non-terminating without blocking threads or consuming CPU.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">IO</span><span class="o">.</span><span class="py">never</span> <span class="o">*&gt;</span> <span class="nc">IO</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="s">"done"</span><span class="o">))</span>
</code></pre></div></div>

<p>The above will never print “done”, block a thread (unless <code class="highlighter-rouge">.unsafeRunSync</code> is run on it), or consume CPU after its creation.</p>

<h2 id="threads">Threads</h2>

<h3 id="threading-on-jvm">Threading (on JVM)</h3>

<p>Threads in JVM map 1:1 to the operating system’s native threads. Calling <code class="highlighter-rouge">new Thread()</code> also creates an operating system thread.
We can create many of them (as long as we can fit them in the memory) but we can only execute 1 per core at the given time. 
Others have to wait for their turn.</p>

<p>If we try to run too many threads at once we will suffer because of many <strong>context switches</strong>.
Before any thread can start doing real work, the OS needs to store state of earlier task and restore the state
for the current one. This cleanup has nontrivial cost. The most efficient situation for CPU-bound tasks
is when we execute as many threads as the number of available cores because we can avoid this overhead.</p>

<p>For the above reasons, synchronous execution can have better throughput than parallel execution. If you parallelize it
too much, it won’t make your code magically faster.  The overhead of creating or switching threads is often greater than the speedup, so make sure to benchmark.</p>

<p>Remember that threads are scarce resource on JVM. If you exploit them at every opportunity
it may turn out that your most performance critical parts of the application suffer because the other part is
doing a lot of work in parallel, taking precious native threads.</p>

<h3 id="thread-pools">Thread Pools</h3>

<p>Creating a <strong>Thread</strong> has a price to it. The overhead depends on the specific JVM and OS, but it involves
making too many threads for short-lived tasks is very inefficient .
It may turn out that process of creating thread and possible context switches has higher costs than the task itself.
Furthermore, having too many threads means that we can eventually run out of memory and that they are
competing for CPU, slowing down the entire application.</p>

<p>It is advised to use <strong>thread pools</strong> created from <code class="highlighter-rouge">java.util.concurrent.Executor</code>.
A thread pool consists of work queue and a pool of running threads. Every task (<code class="highlighter-rouge">Runnable</code>) to execute is
placed in the work queue and the threads that are governed by the pool take it from there to do their work.
In Scala, we avoid explicitly working with <code class="highlighter-rouge">Runnable</code> and use abstractions that do that under the hood
(<code class="highlighter-rouge">Future</code> and <code class="highlighter-rouge">IO</code> implementations). Thread pools can reuse and cache threads to prevent some of the problems
mentioned earlier.</p>

<h3 id="choosing-thread-pool">Choosing Thread Pool</h3>

<p class="responsive-pic"><img src="/cats-effect/img/concurrency-thread-pools.png" alt="thread pools" /></p>

<p>We can configure thread pools in multiple ways:</p>

<h4 id="bounded">Bounded</h4>

<p>Limiting number of available threads to certain amount. Example could be <code class="highlighter-rouge">newSingleThreadExecutor</code> to execute
only one task at the time or limiting number of threads to number of processor cores for CPU-bound tasks.</p>

<h4 id="unbounded">Unbounded</h4>

<p>No maximum limit of available threads. Note that this is dangerous because we could run out of memory by creating
too many threads, so it’s important to use cached pool (allowing to reuse existing threads) with <code class="highlighter-rouge">keepalive</code> time
(to remove useless threads) and control number of tasks to execute by other means (backpressure, rate limiters).</p>

<p>Despite those dangers it is still very useful for blocking tasks. In limited thread pool if we block
too many threads which are waiting for callback from other (blocked) thread for a long time we risk
getting deadlock that prevents any new tasks from starting their work.</p>

<p>For more, read <a href="https://gist.github.com/djspiewak/46b543800958cf61af6efa8e072bfd5c">Daniel Spiewak’s gist.</a></p>

<h3 id="blocking-threads">Blocking Threads</h3>

<p>As a rule we should never block threads, but sometimes we have to work with interface that does it.
Blocking a thread means that it is being wasted and nothing else can be scheduled to run on it.
As mentioned, this can be very dangerous and it’s best to use dedicated thread
pool for blocking operations. This way they won’t interfere with CPU-bound part of application.</p>

<p><a href="https://typelevel.org/cats-effect/api/cats/effect/Blocker.html"><code class="highlighter-rouge">Blocker[IO]</code></a> can be used to safely handle blocking operations
in an explicit way.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">Blocker</span><span class="o">,</span> <span class="nc">ContextShift</span><span class="o">,</span> <span class="nc">IO</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">contextShift</span><span class="k">:</span> <span class="kt">ContextShift</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">contextShift</span><span class="o">(</span><span class="nv">ExecutionContext</span><span class="o">.</span><span class="py">global</span><span class="o">)</span>

<span class="k">def</span> <span class="nf">blockingOp</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="cm">/* blocking op*/</span> <span class="o">())</span>
<span class="k">def</span> <span class="nf">doSth</span><span class="o">()</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="cm">/* do something */</span> <span class="o">())</span>

<span class="k">val</span> <span class="nv">prog</span> <span class="k">=</span> <span class="nc">Blocker</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">use</span> <span class="o">{</span> <span class="n">blocker</span> <span class="k">=&gt;</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">blocker</span><span class="o">.</span><span class="py">blockOn</span><span class="o">(</span><span class="n">blockingOp</span><span class="o">)</span> <span class="c1">// executes on blocker, backed by cached thread pool</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">doSth</span><span class="o">()</span>                     <span class="c1">// executes on contextShift</span>
  <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In most circumstances use a shared <code class="highlighter-rouge">Blocker</code> when carrying out blocking operations.</p>

<p>Other resource with good practices regarding working with blocked threads
<a href="https://monix.io/docs/3x/best-practices/blocking.html">is this section of Monix documentation.</a></p>

<h3 id="green-threads">Green Threads</h3>

<p>There are more types of threads and they depend on the platform. One of them is
<a href="https://en.wikipedia.org/wiki/Green_threads"><em>green thread</em></a>. The main difference
between model represented by JVM Threads and Green Threads is that the latter aren’t scheduled on OS level. They are
much more lightweight, which allows starting a lot of them without many issues.</p>

<p>They are often characterized by <a href="https://en.wikipedia.org/wiki/Cooperative_multitasking">cooperative multitasking</a>
which means the thread decides when it’s giving up control instead of being forcefully preempted, as happens on the JVM.
This term is important for Cats Effect, whose <code class="highlighter-rouge">Fiber</code> and <code class="highlighter-rouge">shift</code> design have a lot of similarities
with this model.</p>

<h2 id="thread-scheduling">Thread Scheduling</h2>
<p>Working with <code class="highlighter-rouge">cats.effect.IO</code> you should notice a lot of calls to <code class="highlighter-rouge">IO.shift</code>, described
in <a href="/cats-effect/datatypes/io.html#thread-shifting">Thread Shifting section in <code class="highlighter-rouge">IO</code> documentation</a></p>

<p>This function allows to shift computation to different thread pool or simply send it to current <code class="highlighter-rouge">ExecutionContext</code>
to schedule it again. This is often called introducing <strong>asynchronous boundary</strong>.</p>

<p>While the first use case is probably easy to imagine, the second one might be more confusing.
It is helpful to actually understand what is happening behind the scenes during <code class="highlighter-rouge">shift</code>.</p>

<p>The Essential term is <strong>thread scheduling</strong>. Since we can’t run all our threads in parallel all the time, they
each get their own slice of time to execute, interleaving with the rest of them so every thread has a chance to run.
When it is time to change threads, the currently running thread is <strong>preempted</strong>. It saves its state and the context switch happens.</p>

<p>This is a bit different when using thread pools (<code class="highlighter-rouge">ExecutionContext</code>s), because they are in charge of
scheduling threads from their own pool. If there is one thread running, it won’t change until it terminates or
higher priority thread is ready to start doing work. Note that <code class="highlighter-rouge">IO</code> without any shifts is considered one task,
so if it’s infinite <code class="highlighter-rouge">IO</code>, it could hog the thread forever and if we use single threaded pool, nothing else
will ever run on it!</p>

<p>In other words, <code class="highlighter-rouge">IO</code> is executing synchronously until we call <code class="highlighter-rouge">IO.shift</code> or use function like <code class="highlighter-rouge">parSequence</code>. 
In terms of individual thread pools, we can actually treat <code class="highlighter-rouge">IO</code> like <strong>green thread</strong> with
<a href="https://en.wikipedia.org/wiki/Cooperative_multitasking">cooperative multitasking</a>.  Instead of
<a href="https://en.wikipedia.org/wiki/Preemption_(computing)#PREEMPTIVE">preemption</a>,
we can decide when we yield to other pending fibers from the same pool by calling <code class="highlighter-rouge">shift</code>. 
Calling <code class="highlighter-rouge">IO.shift</code> schedules the work again, so if there are other <code class="highlighter-rouge">IO</code>s waiting to execute, they can have their chance.</p>

<p>From the thread pool’s point of view, the process of yielding to other fibers can be described like this:</p>
<ul>
  <li>When <code class="highlighter-rouge">shift</code> is called on some fiber:
    <ul>
      <li>Remove that fiber from its current thread and put it in the pool of pending fibers</li>
      <li>For each available thread (including the one from the previous step), assign it one of the pending fibers from the pool</li>
    </ul>
  </li>
</ul>

<p>Allowing different fibers to advance their work is called <strong>fairness</strong>.  Let’s illustrate this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">java.util.concurrent.Executors</span>
<span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">ContextShift</span><span class="o">,</span> <span class="nc">Fiber</span><span class="o">,</span> <span class="nc">IO</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span>

<span class="k">val</span> <span class="nv">ecOne</span> <span class="k">=</span> <span class="nv">ExecutionContext</span><span class="o">.</span><span class="py">fromExecutor</span><span class="o">(</span><span class="nv">Executors</span><span class="o">.</span><span class="py">newSingleThreadExecutor</span><span class="o">())</span>
<span class="k">val</span> <span class="nv">ecTwo</span> <span class="k">=</span> <span class="nv">ExecutionContext</span><span class="o">.</span><span class="py">fromExecutor</span><span class="o">(</span><span class="nv">Executors</span><span class="o">.</span><span class="py">newSingleThreadExecutor</span><span class="o">())</span>

<span class="k">val</span> <span class="nv">csOne</span><span class="k">:</span> <span class="kt">ContextShift</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">contextShift</span><span class="o">(</span><span class="n">ecOne</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">csTwo</span><span class="k">:</span> <span class="kt">ContextShift</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">contextShift</span><span class="o">(</span><span class="n">ecTwo</span><span class="o">)</span>

<span class="k">def</span> <span class="nf">infiniteIO</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="n">cs</span><span class="k">:</span> <span class="kt">ContextShift</span><span class="o">[</span><span class="kt">IO</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Fiber</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Unit</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">repeat</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">id</span><span class="o">)).</span><span class="py">flatMap</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">repeat</span><span class="o">)</span>

  <span class="nv">repeat</span><span class="o">.</span><span class="py">start</span><span class="o">(</span><span class="n">cs</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We have two single threaded <code class="highlighter-rouge">ExecutionContexts</code> (wrapped in <a href="/cats-effect/datatypes/contextshift.html">ContextShift</a>)
and a function that will run <code class="highlighter-rouge">IO</code>, forever printing its identifier.
Note <code class="highlighter-rouge">repeat.start</code> and return type of <code class="highlighter-rouge">IO[Fiber[IO, Unit]]</code> which means that we run this computation in the background.
It will run on thread pool provided by <code class="highlighter-rouge">cs</code>, which we will pass explicitly:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">prog</span> <span class="k">=</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">infiniteIO</span><span class="o">(</span><span class="mi">1</span><span class="o">)(</span><span class="n">csOne</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">infiniteIO</span><span class="o">(</span><span class="mi">11</span><span class="o">)(</span><span class="n">csOne</span><span class="o">)</span>
  <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>

<span class="nv">prog</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
</code></pre></div></div>
<p>It will never print <code class="highlighter-rouge">11</code> despite using <code class="highlighter-rouge">.start</code>!
Why? The <code class="highlighter-rouge">ecOne</code> execution context executes its <code class="highlighter-rouge">IO</code> on the only thread it has, but needs to wait for its
completion before it can schedule the other one.</p>

<p>How about two thread pools?</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">program</span> <span class="k">=</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">infiniteIO</span><span class="o">(</span><span class="mi">1</span><span class="o">)(</span><span class="n">csOne</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">infiniteIO</span><span class="o">(</span><span class="mi">11</span><span class="o">)(</span><span class="n">csOne</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">infiniteIO</span><span class="o">(</span><span class="mi">2</span><span class="o">)(</span><span class="n">csTwo</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">infiniteIO</span><span class="o">(</span><span class="mi">22</span><span class="o">)(</span><span class="n">csTwo</span><span class="o">)</span>
  <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>

<span class="nv">program</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
</code></pre></div></div>

<p>Now it will keep printing both <code class="highlighter-rouge">1</code> and <code class="highlighter-rouge">2</code> but neither <code class="highlighter-rouge">11</code> nor <code class="highlighter-rouge">22</code>. What changed?
Those thread pools are independent and interleave because of thread scheduling done by the operating system.
Basically, the thread pool decides which task gets a thread to run but the OS decides what is actually evaluating on the CPU.</p>

<p>Let’s introduce asynchronous boundaries:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">java.util.concurrent.Executors</span>
<span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">ContextShift</span><span class="o">,</span> <span class="nc">Fiber</span><span class="o">,</span> <span class="nc">IO</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span>

<span class="k">val</span> <span class="nv">ecOne</span> <span class="k">=</span> <span class="nv">ExecutionContext</span><span class="o">.</span><span class="py">fromExecutor</span><span class="o">(</span><span class="nv">Executors</span><span class="o">.</span><span class="py">newSingleThreadExecutor</span><span class="o">())</span>
<span class="k">val</span> <span class="nv">ecTwo</span> <span class="k">=</span> <span class="nv">ExecutionContext</span><span class="o">.</span><span class="py">fromExecutor</span><span class="o">(</span><span class="nv">Executors</span><span class="o">.</span><span class="py">newSingleThreadExecutor</span><span class="o">())</span>

<span class="k">val</span> <span class="nv">csOne</span><span class="k">:</span> <span class="kt">ContextShift</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">contextShift</span><span class="o">(</span><span class="n">ecOne</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">csTwo</span><span class="k">:</span> <span class="kt">ContextShift</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">IO</span><span class="o">.</span><span class="py">contextShift</span><span class="o">(</span><span class="n">ecTwo</span><span class="o">)</span>

<span class="k">def</span> <span class="nf">infiniteIO</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">cs</span><span class="k">:</span> <span class="kt">ContextShift</span><span class="o">[</span><span class="kt">IO</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Fiber</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Unit</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">repeat</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">id</span><span class="o">)).</span><span class="py">flatMap</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nv">IO</span><span class="o">.</span><span class="py">shift</span> <span class="o">*&gt;</span> <span class="n">repeat</span><span class="o">)</span>

  <span class="nv">repeat</span><span class="o">.</span><span class="py">start</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">prog</span> <span class="k">=</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">infiniteIO</span><span class="o">(</span><span class="mi">1</span><span class="o">)(</span><span class="n">csOne</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">infiniteIO</span><span class="o">(</span><span class="mi">11</span><span class="o">)(</span><span class="n">csOne</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">infiniteIO</span><span class="o">(</span><span class="mi">2</span><span class="o">)(</span><span class="n">csTwo</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nf">infiniteIO</span><span class="o">(</span><span class="mi">22</span><span class="o">)(</span><span class="n">csTwo</span><span class="o">)</span>
  <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>

<span class="nv">prog</span><span class="o">.</span><span class="py">unsafeRunSync</span><span class="o">()</span>
</code></pre></div></div>

<p>Notice the <code class="highlighter-rouge">IO.shift *&gt; repeat</code> call. <code class="highlighter-rouge">*&gt;</code> means that we execute first operation, ignore its result and then call <code class="highlighter-rouge">repeat</code>.
Now everything is fair, as we can see each of those numbers printed on the screen.
Calling <code class="highlighter-rouge">IO.shift</code> fixed the problem because when the currently running <code class="highlighter-rouge">IO</code> was rescheduled, it gave an opportunity
to execute the other one.</p>

<p>It probably sounds quite complex and cumbersome to keep track of it yourself but once you understand fundamentals
this explicity can be a great virtue of <code class="highlighter-rouge">cats.effect.IO</code>. Knowing what exactly happens in concurrent scenarios
in your application just by reading the piece of code can really speedup debugging process or even allow to
get it right the first time.</p>

<p>Fortunately <code class="highlighter-rouge">cats.effect.IO</code> doesn’t always require to do it manually. Operations like <code class="highlighter-rouge">race</code>, <code class="highlighter-rouge">parMapN</code>
or <code class="highlighter-rouge">parTraverse</code> introduce asynchronous boundary at the beginning, but if you have limited thread pool and long
running tasks, keep fairness in mind.</p>

<p>Scala’s <code class="highlighter-rouge">Future</code> is optimized for fairness, doing <code class="highlighter-rouge">shift</code> equivalent after each <code class="highlighter-rouge">map</code> or <code class="highlighter-rouge">flatMap</code>.
We wouldn’t have the problem described above but doing it too much results in putting a lot of pressure on
scheduler causing low throughput. In typical purely functional programs we have many <code class="highlighter-rouge">flatMaps</code> because our
entire application is just one big <code class="highlighter-rouge">IO</code> composed of many smaller ones. Constant shifting is not feasible
but there’s always the option to do it if our application has strict latency requirements.</p>

<p>If you are looking for less manual work - <code class="highlighter-rouge">monix.eval.Task</code> is great middleground which by default shifts tasks
automatically in batches preserving both great throughput and decent latency off the shelf and exposes
very rich configuration options if you have more advanced use case.</p>

<h2 id="asynchronous--semantic-blocking">Asynchronous / Semantic blocking</h2>
<p>Sometimes we use term <strong>semantic blocking</strong> or <strong>asynchronous blocking</strong> which is different than blocking thread.
It means that we suspend our IO/Task waiting for some action to happen (e.g. <code class="highlighter-rouge">Deferred.get</code> waits until the
result is available) without blocking a threads.  Other <code class="highlighter-rouge">IO</code>s are free to execute on the thread in the meantime.
This is further explained in <a href="https://github.com/typelevel/cats-effect/issues/243#issuecomment-392002124">Fabio Labella’s comment.</a></p>

<p>It is important to recognize that not all I/O operations are blocking and need to execute on dedicated thread pool.
For instance we can have HTTP requests using non-blocking client such as http4s with Blaze, which
uses non-blocking network I/O and is free to execute on a “normal” pool.</p>


<link rel="stylesheet" type="text/css" href="/cats-effect/css/toc.css"></link>
<script type="text/javascript" src="/cats-effect/js/toc.js"></script>
</section></div></div></div></div><script src="/cats-effect/highlight/highlight.pack.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script src="/cats-effect/js/toc.js"></script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'typelevel/cats-effect'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/cats-effect/js/docs.js"></script></body></html>