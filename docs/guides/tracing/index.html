<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Tracing · Cats Effect</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;nav role=&quot;navigation&quot; id=&quot;toc&quot;&gt;&lt;/nav&gt;"/><meta name="docsearch:version" content="3.x"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Tracing · Cats Effect"/><meta property="og:type" content="website"/><meta property="og:url" content="https://typelevel.org/cats-effect/"/><meta property="og:description" content="&lt;nav role=&quot;navigation&quot; id=&quot;toc&quot;&gt;&lt;/nav&gt;"/><meta property="og:image" content="https://typelevel.org/cats-effect/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://typelevel.org/cats-effect/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/cats-effect/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github-gist.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/cats-effect/js/scrollSpy.js"></script><link rel="stylesheet" href="/cats-effect/css/main.css"/><script src="/cats-effect/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/cats-effect/"><img class="logo" src="/cats-effect/img/cats-effect-logo.svg" alt="Cats Effect"/><h2 class="headerTitleWithLogo">Cats Effect</h2></a><a href="/cats-effect/versions"><h3>3.x</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/cats-effect/docs/getting-started" target="_self">Docs</a></li><li class=""><a href="/cats-effect/api/3.x/cats/effect/index.html" target="_self">API</a></li><li class=""><a href="https://github.com/typelevel/cats-effect" target="_blank">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Tracing</h1></header><article><div><span><p><nav role="navigation" id="toc"></nav></p>
<h2><a class="anchor" aria-hidden="true" id="introduction"></a><a href="#introduction" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Introduction</h2>
<p>Tracing is an advanced feature of <code>IO</code> that offers insight into the execution
graph of a fiber. This unlocks a lot of power for developers in the realm of
debugging and introspection, not only in local development environments
but also in critical production settings.</p>
<p>A notable pain point of working with asynchronous code on the JVM is that
stack traces no longer provide valuable context of the execution path that
a program takes. This limitation is even more pronounced with Scala's <code>Future</code>
(pre- 2.13), where an asynchronous boundary is inserted after each operation.
<code>IO</code>  suffers a similar problem, but even a synchronous <code>IO</code> program's stack
trace is polluted with the details of the <code>IO</code> run-loop.</p>
<p><code>IO</code> solves this problem by collecting a stack trace at various <code>IO</code>
operations that a fiber executes, and knitting them together to produce a more
coherent view of the fiber's execution path. For example, here is a trace of a
sample program that is running in cached stack tracing mode:</p>
<pre><code class="hljs">IOTrace: 13 frames captured, 0 omitted
 ├ flatMap at org.simpleapp.example.Example.run (Example.scala:67)
 ├ flatMap at org.simpleapp.example.Example.program (Example.scala:57)
 ├ flatMap at org.simpleapp.example.Example.program (Example.scala:58)
 ├ flatMap at org.simpleapp.example.Example.program (Example.scala:59)
 ├ flatMap at org.simpleapp.example.Example.program (Example.scala:60)
 ├ async at org.simpleapp.example.Example.program (Example.scala:60)
 ├ flatMap at org.simpleapp.example.Example.program (Example.scala:61)
 ├ flatMap at org.simpleapp.example.Example.program (Example.scala:60)
 ├ flatMap at org.simpleapp.example.Example.program2 (Example.scala:51)
 ├ map at org.simpleapp.example.Example.program2 (Example.scala:52)
 ├ map at org.simpleapp.example.Example.program (Example.scala:60)
 ├ map at org.simpleapp.example.Example.program (Example.scala:62)
 ╰ flatMap at org.simpleapp.example.Example.run (Example.scala:67)
</code></pre>
<p>However, fiber tracing isn't limited to collecting stack traces. Tracing
has many use cases that improve developer experience and aid in understanding
how our applications work. These features are described below. A <strong>bolded name</strong>
indicates that the feature has been merged into master.</p>
<ol>
<li><strong>Asynchronous stack tracing</strong>. This is essentially what is described above,
where stack frames are collected across asynchronous boundaries for a given
fiber.</li>
<li><strong>Combinator inference</strong>. Stack traces can be walked to determine what
combinator was actually called by user code. For example, <code>void</code> and <code>as</code> are
combinators that are derived from <code>map</code>, and should appear in the fiber trace
rather than <code>map</code>.</li>
<li>Intermediate values. The intermediate values that an <code>IO</code> program encounters
can be converted to a string to render. This can aid in understanding the
actions that a program takes.</li>
<li>Thread tracking. A fiber is scheduled on potentially many threads throughout
its lifetime. Knowing what thread a fiber is running on, and when it shifts
threads is a powerful tool for understanding and debugging the concurrency of
an application.</li>
<li>Tree rendering. By collecting a trace of all <code>IO</code> operations, a pretty tree
or graph can be rendered to visualize fiber execution.</li>
<li>Fiber identity. Fibers, like threads, are unique and can therefore assume an
identity. If user code can observe fiber identity, powerful observability tools
can be built on top of it. For example, another shortcoming of asynchronous
code is that it becomes tedious to correlate log messages across asynchronous
boundaries (thread IDs aren't very useful). With fiber identity, log messages
produced by a single fiber can be associated with a unique, stable identifier.</li>
<li>Fiber ancestry graph. If fibers can assume an identity, an ancestry graph
can be formed, where nodes are fibers and edges represent a fork/join
relationship.</li>
<li>Asynchronous deadlock detection. Even when working with asynchronously
blocking code, fiber deadlocks aren't impossible. Being able to detect
deadlocks or infer when a deadlock can happen makes writing concurrent code
much easier.</li>
<li>Live fiber trace dumps. Similar to JVM thread dumps, the execution status
and trace information of all fibers in an application can be extracted for
debugging purposes.</li>
<li>Monad transformer analysis.</li>
</ol>
<p>As note of caution, fiber tracing generally introduces overhead to
applications in the form of higher CPU usage, memory and GC pressure.
Always remember to performance test your applications with tracing enabled
before deploying it to a production environment!</p>
<h2><a class="anchor" aria-hidden="true" id="asynchronous-stack-tracing"></a><a href="#asynchronous-stack-tracing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Asynchronous stack tracing</h2>
<h3><a class="anchor" aria-hidden="true" id="configuration"></a><a href="#configuration" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configuration</h3>
<p>The stack tracing mode of an application is configured by the system property
<code>cats.effect.stackTracingMode</code>. There are three stack tracing modes: <code>DISABLED</code>,
<code>CACHED</code> and <code>FULL</code>. These values are case-insensitive.</p>
<p>To prevent unbounded memory usage, stack traces for a fiber are accumulated
in an internal buffer as execution proceeds. If more traces are collected than
the buffer can retain, then the older traces will be overwritten. The default
size for the buffer is 128, but can be changed via the system property
<code>cats.effect.traceBufferSize</code>. Keep in mind that the buffer size will always
be rounded up to a power of 2.</p>
<p>For example, to enable full stack tracing and a trace buffer size of 1024,
specify the following system properties:</p>
<pre><code class="hljs">-Dcats.effect.stackTracingMode=full -Dcats.effect.traceBufferSize=1024
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="disabled"></a><a href="#disabled" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>DISABLED</h4>
<p>No tracing is instrumented by the program and so incurs negligible impact to
performance. If a trace is requested, it will be empty.</p>
<h4><a class="anchor" aria-hidden="true" id="cached"></a><a href="#cached" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CACHED</h4>
<p>When cached stack tracing is enabled, a stack trace is captured and cached for
every <code>map</code>, <code>flatMap</code> and <code>async</code> call in a program.</p>
<p>The stack trace cache is indexed by the lambda class reference, so cached
tracing may produce inaccurate fiber traces under several scenarios:</p>
<ol>
<li>Monad transformer composition</li>
<li>A named function is supplied to <code>map</code>, <code>async</code> or <code>flatMap</code> at multiple
call-sites</li>
</ol>
<p>We measured less than a 30% performance hit when cached tracing is enabled
for a completely synchronous <code>IO</code> program, but it will most likely be much less
for any program that performs any sort of I/O. We strongly recommend
benchmarking applications that make use of tracing.</p>
<p>This is the recommended mode to run in most production applications and is
enabled by default.</p>
<h4><a class="anchor" aria-hidden="true" id="full"></a><a href="#full" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>FULL</h4>
<p>When full stack tracing is enabled, a stack trace is captured for most <code>IO</code>
combinators including <code>pure</code>, <code>delay</code>, <code>suspend</code>, <code>raiseError</code> as well as those
traced in cached mode.</p>
<p>Stack traces are collected <em>on every invocation</em>, so naturally most programs
will experience a significant performance hit. This mode is mainly useful for
debugging in development environments.</p>
<h3><a class="anchor" aria-hidden="true" id="requesting-and-printing-traces"></a><a href="#requesting-and-printing-traces" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Requesting and printing traces</h3>
<p>Once the global tracing flag is configured, <code>IO</code> programs will automatically
begin collecting traces. The trace for a fiber can be accessed at any point
during its execution via the <code>IO.trace</code> combinator. This is the <code>IO</code> equivalent
of capturing a thread's stack trace.</p>
<p>After we have a fiber trace, we can print it to the console, not unlike how
Java exception stack traces are printed with <code>printStackTrace</code>. <code>printFiberTrace</code>
can be called to print fiber traces to the consoles. Printing behavior can be
customized by passing in a <code>PrintingOptions</code> instance. By default, a fiber trace
is rendered in a very compact presentation that includes the most relevant stack
trace element from each fiber operation.</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> cats.effect.<span class="hljs-type">IO</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">program</span></span>: <span class="hljs-type">IO</span>[<span class="hljs-type">Unit</span>] =
  <span class="hljs-keyword">for</span> {
    _     &lt;- <span class="hljs-type">IO</span>(println(<span class="hljs-string">"Started the program"</span>))
    trace &lt;- <span class="hljs-type">IO</span>.trace
    _     &lt;- trace.printFiberTrace()
  } <span class="hljs-keyword">yield</span> ()
</code></pre>
<p>Keep in mind that the scope and amount of information that traces hold will
change over time as additional fiber tracing features are merged into master.</p>
<h2><a class="anchor" aria-hidden="true" id="enhanced-exceptions"></a><a href="#enhanced-exceptions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enhanced exceptions</h2>
<p>The stack trace of an exception caught by the IO runloop looks similar to the
following output:</p>
<pre><code class="hljs">java.lang.Throwable: A runtime exception has occurred
    at org.simpleapp.examples.Main$.b(Main.scala:28)
    at org.simpleapp.examples.Main$.a(Main.scala:25)
    at org.simpleapp.examples.Main$.$anonfun$foo$11(Main.scala:37)
    at scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)
    at cats.effect.internals.IORunLoop$.cats$effect$internals$IORunLoop$$loop(IORunLoop.scala:103)
    at cats.effect.internals.IORunLoop$RestartCallback.signal(IORunLoop.scala:440)
    at cats.effect.internals.IORunLoop$RestartCallback.apply(IORunLoop.scala:461)
    at cats.effect.internals.IORunLoop$RestartCallback.apply(IORunLoop.scala:399)
    at cats.effect.internals.IOShift$Tick.run(IOShift.scala:36)
    at cats.effect.internals.PoolUtils$$anon$2$$anon$3.run(PoolUtils.scala:52)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
    at java.lang.Thread.run(Thread.java:748)
</code></pre>
<p>It includes stack frames that are part of the IO runloop, which are generally
not of interest to users of the library. When asynchronous stack tracing is
enabled, the IO runloop is capable of augmenting the stack traces of caught
exceptions to include frames from the asynchronous stack traces. For example,
the augmented version of the above stack trace looks like the following:</p>
<pre><code class="hljs">java.lang.Throwable: A runtime exception has occurred
    at org.simpleapp.examples.Main$.b(Main.scala:28)
    at org.simpleapp.examples.Main$.a(Main.scala:25)
    at org.simpleapp.examples.Main$.$anonfun$foo$11(Main.scala:37)
    at map @ org.simpleapp.examples.Main$.$anonfun$foo$10(Main.scala:37)
    at flatMap @ org.simpleapp.examples.Main$.$anonfun$foo$8(Main.scala:36)
    at flatMap @ org.simpleapp.examples.Main$.$anonfun$foo$6(Main.scala:35)
    at flatMap @ org.simpleapp.examples.Main$.$anonfun$foo$4(Main.scala:34)
    at flatMap @ org.simpleapp.examples.Main$.$anonfun$foo$2(Main.scala:33)
    at flatMap @ org.simpleapp.examples.Main$.foo(Main.scala:32)
    at flatMap @ org.simpleapp.examples.Main$.program(Main.scala:42)
    at as @ org.simpleapp.examples.Main$.run(Main.scala:48)
    at main$ @ org.simpleapp.examples.Main$.main(Main.scala:22)
</code></pre>
<p>Note that the relevant stack frames from the call-site of the user code
is preserved, but all IO-related stack frames are replaced with async
stack trace frames.</p>
<p>This feature is controlled by the system property
<code>cats.effect.enhancedExceptions</code>. It is enabled by default.</p>
<pre><code class="hljs">-Dcats.effect.enhancedExceptions=false
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="complete-example"></a><a href="#complete-example" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Complete example</h3>
<p>Here is a sample program that demonstrates tracing in action.</p>
<pre><code class="hljs css language-scala"><span class="hljs-comment">// Pass the following system property to your JVM:</span>
<span class="hljs-comment">// -Dcats.effect.stackTracingMode=full</span>

<span class="hljs-keyword">import</span> cats.effect.tracing.<span class="hljs-type">PrintingOptions</span>
<span class="hljs-keyword">import</span> cats.syntax.all._
<span class="hljs-keyword">import</span> cats.effect.{<span class="hljs-type">ExitCode</span>, <span class="hljs-type">IO</span>, <span class="hljs-type">IOApp</span>}

<span class="hljs-keyword">import</span> scala.util.<span class="hljs-type">Random</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Example</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IOApp</span> </span>{

  <span class="hljs-keyword">val</span> options = <span class="hljs-type">PrintingOptions</span>.<span class="hljs-type">Default</span>
    .withShowFullStackTraces(<span class="hljs-literal">true</span>)
    .withMaxStackTraceLines(<span class="hljs-number">8</span>)

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fib</span></span>(n: <span class="hljs-type">Int</span>, a: <span class="hljs-type">Long</span> = <span class="hljs-number">0</span>, b: <span class="hljs-type">Long</span> = <span class="hljs-number">1</span>): <span class="hljs-type">IO</span>[<span class="hljs-type">Long</span>] =
    <span class="hljs-type">IO</span>(a + b).flatMap { b2 =&gt;
      <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">0</span>)
        fib(n - <span class="hljs-number">1</span>, b, b2)
      <span class="hljs-keyword">else</span>
        <span class="hljs-type">IO</span>.pure(b2)
    }
  
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">program</span></span>: <span class="hljs-type">IO</span>[<span class="hljs-type">Unit</span>] =
    <span class="hljs-keyword">for</span> {
      x &lt;- fib(<span class="hljs-number">20</span>)
      _ &lt;- <span class="hljs-type">IO</span>(println(<span class="hljs-string">s"The 20th fibonacci number is <span class="hljs-subst">$x</span>"</span>))
      _ &lt;- <span class="hljs-type">IO</span>(<span class="hljs-type">Random</span>.nextBoolean()).ifM(<span class="hljs-type">IO</span>.raiseError(<span class="hljs-keyword">new</span> <span class="hljs-type">Throwable</span>(<span class="hljs-string">""</span>)), <span class="hljs-type">IO</span>.unit)
    } <span class="hljs-keyword">yield</span> ()

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span></span>(args: <span class="hljs-type">List</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">IO</span>[<span class="hljs-type">ExitCode</span>] =
    <span class="hljs-keyword">for</span> {
      _ &lt;- program.handleErrorWith(_ =&gt; <span class="hljs-type">IO</span>.trace.flatMap(_.printFiberTrace(options)))
    } <span class="hljs-keyword">yield</span> <span class="hljs-type">ExitCode</span>.<span class="hljs-type">Success</span>

}
</code></pre>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#introduction">Introduction</a></li><li><a href="#asynchronous-stack-tracing">Asynchronous stack tracing</a><ul class="toc-headings"><li><a href="#configuration">Configuration</a></li><li><a href="#requesting-and-printing-traces">Requesting and printing traces</a></li></ul></li><li><a href="#enhanced-exceptions">Enhanced exceptions</a><ul class="toc-headings"><li><a href="#complete-example">Complete example</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/cats-effect/" class="nav-home"><img src="/cats-effect/img/cats-effect-logo.svg" alt="Cats Effect" width="66" height="58"/></a><div><h5>Docs</h5><a href="/cats-effect/docs/getting-started">Getting Started</a><a href="/cats-effect/docs/tutorial">Tutorial</a><a href="/cats-effect/docs/typeclasses">Typeclasses</a><a href="/cats-effect/docs/schedulers">Schedulers</a></div><div><h5>Community</h5><a target="_blank" href="https://typelevel.org/blog/">Blog</a><a target="_blank" href="https://discord.gg/HmPs7rAtEY">Discord</a></div><div><h5>More</h5><a class="github-button" href="https://github.com/typelevel/cats-effect" data-icon="octicon-star" data-count-href="/typelevel/cats-effect/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><div class="social"><a href="https://twitter.com/typelevel" class="twitter-follow-button">Follow @typelevel</a></div></div></section><section class="copyright">Copyright (c) 2017-2022 Typelevel</section></footer></div><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script></body></html>